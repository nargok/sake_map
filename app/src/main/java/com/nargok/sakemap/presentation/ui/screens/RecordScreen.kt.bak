package com.nargok.sakemap.ui.screens

import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.ArrowDropDown
import androidx.compose.material.icons.filled.Add
import androidx.compose.material.icons.filled.DateRange
import androidx.compose.material.icons.filled.Star
import androidx.compose.material.icons.outlined.Star
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.input.TextFieldValue
import androidx.compose.ui.tooling.preview.Preview
import androidx.compose.ui.unit.dp
import com.nargok.sakemap.data.DrinkType
import com.nargok.sakemap.utils.getDrinkTypeText
import java.time.LocalDate
import java.time.format.DateTimeFormatter

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun RecordScreen(
    onSave: (String, DrinkType, String, Int, LocalDate) -> Unit = { _, _, _, _, _ -> }
) {
    var drinkName by remember { mutableStateOf(TextFieldValue("")) }
    var selectedDrinkType by remember { mutableStateOf<DrinkType?>(null) }
    var selectedPrefecture by remember { mutableStateOf<String?>(null) }
    var rating by remember { mutableIntStateOf(0) }
    var selectedDate by remember { mutableStateOf(LocalDate.now()) }
    var showDrinkTypeDropdown by remember { mutableStateOf(false) }
    var showPrefectureDropdown by remember { mutableStateOf(false) }
    var showDatePicker by remember { mutableStateOf(false) }
    
    // Validation states
    var drinkNameError by remember { mutableStateOf<String?>(null) }
    var drinkTypeError by remember { mutableStateOf<String?>(null) }
    var prefectureError by remember { mutableStateOf<String?>(null) }
    var ratingError by remember { mutableStateOf<String?>(null) }

    Column(
        modifier = Modifier
            .fillMaxSize()
            .padding(16.dp)
            .verticalScroll(rememberScrollState()),
        verticalArrangement = Arrangement.spacedBy(16.dp)
    ) {
        // Header
        Text(
            text = "ãŠé…’ã‚’è¨˜éŒ²",
            style = MaterialTheme.typography.headlineMedium,
            fontWeight = FontWeight.Bold
        )

        // Photo capture area
        PhotoCaptureArea(
            modifier = Modifier.fillMaxWidth()
        )

        // Drink name input
        Column {
            OutlinedTextField(
                value = drinkName,
                onValueChange = { 
                    drinkName = it
                    drinkNameError = validateDrinkName(it.text)
                },
                label = { Text("éŠ˜æŸ„å") },
                modifier = Modifier.fillMaxWidth(),
                isError = drinkNameError != null,
                supportingText = drinkNameError?.let { { Text(it, color = MaterialTheme.colorScheme.error) } }
            )
        }

        // Drink type dropdown
        Column {
            ExposedDropdownMenuBox(
                expanded = showDrinkTypeDropdown,
                onExpandedChange = { showDrinkTypeDropdown = it }
            ) {
                OutlinedTextField(
                    value = selectedDrinkType?.let { getDrinkTypeText(it) } ?: "",
                    onValueChange = {},
                    readOnly = true,
                    label = { Text("ãŠé…’ã®ç¨®é¡") },
                    trailingIcon = {
                        Icon(Icons.Default.ArrowDropDown, contentDescription = null)
                    },
                    modifier = Modifier
                        .fillMaxWidth()
                        .menuAnchor(),
                    isError = drinkTypeError != null
                )
                
                ExposedDropdownMenu(
                    expanded = showDrinkTypeDropdown,
                    onDismissRequest = { showDrinkTypeDropdown = false }
                ) {
                    DrinkType.entries.forEach { drinkType ->
                        DropdownMenuItem(
                            text = { Text(getDrinkTypeText(drinkType)) },
                            onClick = {
                                selectedDrinkType = drinkType
                                drinkTypeError = null
                                showDrinkTypeDropdown = false
                            }
                        )
                    }
                }
            }
            drinkTypeError?.let {
                Text(
                    text = it,
                    color = MaterialTheme.colorScheme.error,
                    style = MaterialTheme.typography.bodySmall,
                    modifier = Modifier.padding(start = 16.dp, top = 4.dp)
                )
            }
        }

        // Prefecture dropdown
        Column {
            ExposedDropdownMenuBox(
                expanded = showPrefectureDropdown,
                onExpandedChange = { showPrefectureDropdown = it }
            ) {
                OutlinedTextField(
                    value = selectedPrefecture ?: "",
                    onValueChange = {},
                    readOnly = true,
                    label = { Text("éƒ½é“åºœçœŒ") },
                    trailingIcon = {
                        Icon(Icons.Default.ArrowDropDown, contentDescription = null)
                    },
                    modifier = Modifier
                        .fillMaxWidth()
                        .menuAnchor(),
                    isError = prefectureError != null
                )
                
                ExposedDropdownMenu(
                    expanded = showPrefectureDropdown,
                    onDismissRequest = { showPrefectureDropdown = false }
                ) {
                    getPrefectures().forEach { prefecture ->
                        DropdownMenuItem(
                            text = { Text(prefecture) },
                            onClick = {
                                selectedPrefecture = prefecture
                                prefectureError = null
                                showPrefectureDropdown = false
                            }
                        )
                    }
                }
            }
            prefectureError?.let {
                Text(
                    text = it,
                    color = MaterialTheme.colorScheme.error,
                    style = MaterialTheme.typography.bodySmall,
                    modifier = Modifier.padding(start = 16.dp, top = 4.dp)
                )
            }
        }

        // Rating selection
        Column {
            Text(
                text = "è©•ä¾¡",
                style = MaterialTheme.typography.bodyLarge,
                fontWeight = FontWeight.Medium
            )
            
            Row(
                modifier = Modifier.padding(vertical = 8.dp),
                horizontalArrangement = Arrangement.spacedBy(8.dp)
            ) {
                repeat(5) { index ->
                    Icon(
                        imageVector = if (index < rating) Icons.Filled.Star else Icons.Outlined.Star,
                        contentDescription = "${index + 1}ã¤æ˜Ÿ",
                        tint = if (index < rating) Color(0xFFFFD700) else MaterialTheme.colorScheme.outline,
                        modifier = Modifier
                            .size(32.dp)
                            .clickable {
                                rating = index + 1
                                ratingError = null
                            }
                    )
                }
            }
            
            ratingError?.let {
                Text(
                    text = it,
                    color = MaterialTheme.colorScheme.error,
                    style = MaterialTheme.typography.bodySmall,
                    modifier = Modifier.padding(top = 4.dp)
                )
            }
        }

        // Date picker
        Column {
            OutlinedTextField(
                value = selectedDate.format(DateTimeFormatter.ofPattern("yyyyå¹´MMæœˆddæ—¥")),
                onValueChange = {},
                readOnly = true,
                label = { Text("é£²ã‚“ã æ—¥ä»˜") },
                trailingIcon = {
                    IconButton(onClick = { showDatePicker = true }) {
                        Icon(Icons.Default.DateRange, contentDescription = "æ—¥ä»˜é¸æŠ")
                    }
                },
                modifier = Modifier.fillMaxWidth()
            )
        }

        Spacer(modifier = Modifier.height(16.dp))

        // Save button
        Button(
            onClick = {
                val isValid = validateForm(
                    drinkName.text,
                    selectedDrinkType,
                    selectedPrefecture,
                    rating
                ) { nameError, typeError, prefError, rateError ->
                    drinkNameError = nameError
                    drinkTypeError = typeError
                    prefectureError = prefError
                    ratingError = rateError
                }
                
                if (isValid && selectedDrinkType != null && selectedPrefecture != null) {
                    onSave(drinkName.text, selectedDrinkType!!, selectedPrefecture!!, rating, selectedDate)
                }
            },
            modifier = Modifier.fillMaxWidth(),
            colors = ButtonDefaults.buttonColors(
                containerColor = MaterialTheme.colorScheme.primary
            )
        ) {
            Text("ä¿å­˜", style = MaterialTheme.typography.titleMedium)
        }
    }

    // Date picker dialog (placeholder)
    if (showDatePicker) {
        AlertDialog(
            onDismissRequest = { showDatePicker = false },
            title = { Text("æ—¥ä»˜ã‚’é¸æŠ") },
            text = { Text("å®Ÿéš›ã®å®Ÿè£…ã§ã¯ DatePickerDialog ã‚’ä½¿ç”¨ã—ã¾ã™") },
            confirmButton = {
                TextButton(onClick = { showDatePicker = false }) {
                    Text("OK")
                }
            }
        )
    }
}

@Composable
fun PhotoCaptureArea(
    modifier: Modifier = Modifier
) {
    var hasPhoto by remember { mutableStateOf(false) }
    
    Box(
        modifier = modifier
            .height(200.dp)
            .clip(RoundedCornerShape(12.dp))
            .background(MaterialTheme.colorScheme.surfaceVariant)
            .border(
                1.dp,
                MaterialTheme.colorScheme.outline,
                RoundedCornerShape(12.dp)
            )
            .clickable { hasPhoto = !hasPhoto },
        contentAlignment = Alignment.Center
    ) {
        if (hasPhoto) {
            Column(
                horizontalAlignment = Alignment.CenterHorizontally,
                verticalArrangement = Arrangement.spacedBy(8.dp)
            ) {
                Text(
                    text = "ğŸ“·",
                    style = MaterialTheme.typography.displayMedium
                )
                Text(
                    text = "æ’®å½±æ¸ˆã¿å†™çœŸ",
                    style = MaterialTheme.typography.bodyMedium,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
                Text(
                    text = "ã‚¿ãƒƒãƒ—ã§å†æ’®å½±",
                    style = MaterialTheme.typography.bodySmall,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
            }
        } else {
            Column(
                horizontalAlignment = Alignment.CenterHorizontally,
                verticalArrangement = Arrangement.spacedBy(8.dp)
            ) {
                Icon(
                    Icons.Default.Add,
                    contentDescription = "ã‚«ãƒ¡ãƒ©",
                    tint = MaterialTheme.colorScheme.onSurfaceVariant,
                    modifier = Modifier.size(48.dp)
                )
                Text(
                    text = "å†™çœŸã‚’æ’®å½±",
                    style = MaterialTheme.typography.bodyMedium,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
                Text(
                    text = "ã‚¿ãƒƒãƒ—ã—ã¦ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•",
                    style = MaterialTheme.typography.bodySmall,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
            }
        }
    }
}


fun getPrefectures(): List<String> {
    return listOf(
        "åŒ—æµ·é“", "é’æ£®çœŒ", "å²©æ‰‹çœŒ", "å®®åŸçœŒ", "ç§‹ç”°çœŒ", "å±±å½¢çœŒ", "ç¦å³¶çœŒ",
        "èŒ¨åŸçœŒ", "æ ƒæœ¨çœŒ", "ç¾¤é¦¬çœŒ", "åŸ¼ç‰çœŒ", "åƒè‘‰çœŒ", "æ±äº¬éƒ½", "ç¥å¥ˆå·çœŒ",
        "æ–°æ½ŸçœŒ", "å¯Œå±±çœŒ", "çŸ³å·çœŒ", "ç¦äº•çœŒ", "å±±æ¢¨çœŒ", "é•·é‡çœŒ", "å²é˜œçœŒ",
        "é™å²¡çœŒ", "æ„›çŸ¥çœŒ", "ä¸‰é‡çœŒ", "æ»‹è³€çœŒ", "äº¬éƒ½åºœ", "å¤§é˜ªåºœ", "å…µåº«çœŒ",
        "å¥ˆè‰¯çœŒ", "å’Œæ­Œå±±çœŒ", "é³¥å–çœŒ", "å³¶æ ¹çœŒ", "å²¡å±±çœŒ", "åºƒå³¶çœŒ", "å±±å£çœŒ",
        "å¾³å³¶çœŒ", "é¦™å·çœŒ", "æ„›åª›çœŒ", "é«˜çŸ¥çœŒ", "ç¦å²¡çœŒ", "ä½è³€çœŒ", "é•·å´çœŒ",
        "ç†Šæœ¬çœŒ", "å¤§åˆ†çœŒ", "å®®å´çœŒ", "é¹¿å…å³¶çœŒ", "æ²–ç¸„çœŒ"
    )
}

fun validateDrinkName(name: String): String? {
    return when {
        name.isBlank() -> "éŠ˜æŸ„åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
        name.length > 50 -> "éŠ˜æŸ„åã¯50æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„"
        else -> null
    }
}

fun validateForm(
    drinkName: String,
    drinkType: DrinkType?,
    prefecture: String?,
    rating: Int,
    onValidationResult: (String?, String?, String?, String?) -> Unit
): Boolean {
    val nameError = validateDrinkName(drinkName)
    val typeError = if (drinkType == null) "ãŠé…’ã®ç¨®é¡ã‚’é¸æŠã—ã¦ãã ã•ã„" else null
    val prefError = if (prefecture == null) "éƒ½é“åºœçœŒã‚’é¸æŠã—ã¦ãã ã•ã„" else null
    val ratingError = if (rating == 0) "è©•ä¾¡ã‚’é¸æŠã—ã¦ãã ã•ã„" else null
    
    onValidationResult(nameError, typeError, prefError, ratingError)
    
    return nameError == null && typeError == null && prefError == null && ratingError == null
}

@Preview(showBackground = true)
@Composable
fun RecordScreenPreview() {
    MaterialTheme {
        RecordScreen()
    }
}

@Preview(showBackground = true)
@Composable
fun PhotoCaptureAreaPreview() {
    MaterialTheme {
        Column(
            modifier = Modifier.padding(16.dp),
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            Text("å†™çœŸãªã—:")
            PhotoCaptureArea(modifier = Modifier.fillMaxWidth())
        }
    }
}